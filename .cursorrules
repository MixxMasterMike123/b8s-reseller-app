# B8Shield Reseller Portal - Cursor Rules

## Project Overview
B8Shield is a Swedish reseller portal for JPH Innovation AB's fishing lure protection product. The portal manages customer orders, user accounts, and provides admin functionality for customer management. **NEW**: Now includes a stunning B2C e-commerce storefront at shop.b8shield.com.

## Technology Stack
- **Frontend**: React 18 + Vite
- **Styling**: Tailwind CSS
- **Backend**: Firebase (Firestore, Auth, Hosting)
- **State Management**: React Context API
- **Routing**: React Router
- **Icons**: Heroicons
- **Notifications**: react-hot-toast
- **Date Handling**: date-fns with Swedish locale
- **Rich Text Editor**: react-quill for B2C product descriptions

## Dual Platform Architecture (Latest)
- **B2B Portal**: `b8shield-reseller-app.web.app` - Reseller management system
- **B2C Shop**: `shop.b8shield.com` - Consumer e-commerce storefront
- **Shared Backend**: Same Firebase project, unified product database
- **Subdomain Routing**: Automatic detection and routing based on subdomain

## Key Project Structure
```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ auth/ (PrivateRoute, AdminRoute)
â”‚   â”œâ”€â”€ layout/ (AppLayout)
â”‚   â””â”€â”€ shop/ (Shared B2C components)
â”‚       â””â”€â”€ ShopNavigation.jsx (Shared header with cart)
â”œâ”€â”€ contexts/
â”‚   â”œâ”€â”€ AuthContext.jsx
â”‚   â”œâ”€â”€ CartContext.jsx (Shopping cart state management)
â”‚   â””â”€â”€ OrderContext.jsx
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ admin/ (AdminDashboard, AdminUsers, AdminOrders, AdminProducts)
â”‚   â”œâ”€â”€ shop/ (B2C storefront components)
â”‚   â”‚   â”œâ”€â”€ PublicStorefront.jsx (Main B2C shop)
â”‚   â”‚   â”œâ”€â”€ PublicProductPage.jsx
â”‚   â”‚   â”œâ”€â”€ ShoppingCart.jsx
â”‚   â”‚   â”œâ”€â”€ Checkout.jsx
â”‚   â”‚   â”œâ”€â”€ CustomerLogin.jsx
â”‚   â”‚   â”œâ”€â”€ CustomerRegister.jsx
â”‚   â”‚   â””â”€â”€ CustomerAccount.jsx
â”‚   â”œâ”€â”€ ProductViewPage (B2B product catalog)
â”‚   â””â”€â”€ [user pages]
â”œâ”€â”€ firebase/config.js
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ marketingMaterials.js
â”‚   â””â”€â”€ productImages.js (B2C image generation)
â””â”€â”€ App.jsx (Subdomain routing logic)
```

## Language & Terminology
- **Primary Language**: Swedish (Svenska)
- **Users**: Referred to as "Kunder" (customers) or "FÃ¶retag" (companies)
- **UI Text**: Swedish throughout (e.g., "Kundhantering", "BestÃ¤llningar", "InstÃ¤llningar")
- **Field Names**: Swedish database fields (e.g., `marginal`, `fÃ¶retagsnamn`)

## Key Features Implemented

### B2C E-commerce Storefront (Latest)
- **Stunning 2025 Design**: Modern gradients, glassmorphism, micro-interactions
- **Subdomain Routing**: Automatic B2B/B2C detection via shop.b8shield.com
- **Professional Swedish Interface**: Consumer-focused e-commerce experience
- **Product Showcase**: Generated B8Shield images with color variants
- **Social Proof**: 5-star testimonial from Paul Wieringa integration
- **Mobile-First Design**: Responsive across all devices
- **Conversion Optimization**: Hero section, features, call-to-actions
- **Debug Mode**: Visual indicators for testing subdomain detection

### Customer Management System
- Individual customer margins (default: 35%)
- Admin can edit customer margins inline
- Customer activation/deactivation
- Role management (user/admin)
- Swedish terminology throughout
- Comprehensive customer profiles with delivery addresses

### Product Management & Catalog
- **Admin Product Management**: Full CRUD operations with Swedish interface
- **B2B Customer Catalog**: View-only access at `/products` route
- **B2C Public Catalog**: Consumer storefront with generated product images
- **EAN Code Support**: String field + PNG/JPG and SVG image uploads
- **Download Capabilities**: Customers can download product images and EAN codes
- **Sorting & Filtering**: Alphabetical sorting, product filter dropdown
- **Mobile Optimized**: Responsive design for all devices

### Authentication & Authorization
- Firebase Authentication
- Role-based access (user/admin)
- Admin-only routes and functions
- Account activation required

### Order Management
- Order creation and tracking
- Status management
- Order history
- Admin order oversight

## Database Schema (Firestore)

### Users Collection
```javascript
{
  id: string,
  email: string,
  companyName: string,
  contactPerson: string,
  phone: string,
  orgNumber: string,
  address: string,
  city: string,
  postalCode: string,
  country: string,
  deliveryAddress: string,
  deliveryCity: string,
  deliveryPostalCode: string,
  deliveryCountry: string,
  sameAsCompanyAddress: boolean,
  role: 'user' | 'admin',
  active: boolean,
  marginal: number, // Customer margin percentage (default: 35)
  notes: string,
  createdAt: string,
  updatedAt: string
}
```

### Products Collection (Enhanced for B2B/B2C with Firebase Storage)
```javascript
{
  id: string,
  name: string,
  description: string,
  size: string,
  basePrice: number,
  manufacturingCost: number,
  isActive: boolean,
  
  // Current Firebase Storage image fields
  imageUrl: string, // Firebase Storage URL for product image
  eanCode: string,
  eanImagePngUrl: string, // Firebase Storage URL for PNG/JPG EAN barcode
  eanImageSvgUrl: string, // Firebase Storage URL for SVG EAN barcode
  
  // Legacy base64 fields (backward compatibility)
  imageData: string, // Base64 product image (deprecated)
  eanImagePng: string, // Base64 PNG/JPG EAN barcode (deprecated)
  eanImageSvg: string, // Base64 SVG EAN barcode (deprecated)
  
  // PLANNED: Enhanced B2B/B2C fields
  // b2bImageUrl: string,         // B2B technical images (Firebase Storage)
  // b2cImageUrl: string,         // B2C lifestyle images (Firebase Storage)
  // b2cImageGallery: [string],   // Additional B2C images (Firebase Storage URLs)
  // availability: {
  //   b2b: boolean,
  //   b2c: boolean,
  //   b2bMinQuantity: number,
  //   b2cMaxQuantity: number
  // },
  // variants: { b2b: {}, b2c: {} },
  // descriptions: { b2b: string, b2c: string },
  
  createdAt: string,
  updatedAt: string
}
```

### Orders Collection
```javascript
{
  id: string,
  userId: string,
  status: string,
  items: array,
  totalAmount: number,
  createdAt: string,
  updatedAt: string
}
```

## Coding Conventions

### React Patterns
- Functional components with hooks
- Context API for global state
- Custom hooks for reusable logic
- Consistent error handling with toast notifications

### Styling Guidelines
- Tailwind CSS utility classes
- Consistent color scheme (blue primary, gray neutrals)
- Mobile-first responsive design
- Hover states and transitions
- **2025 Design Elements**: Gradients, glassmorphism, micro-interactions

### Firebase Integration
- **ALWAYS use named database**: `b8s-reseller-db` (NEVER use default database)
- Error handling for offline scenarios
- Real-time updates where appropriate
- Proper security rules

## Admin Features
- Customer management with inline editing
- Margin percentage control per customer
- User activation/deactivation
- Order oversight and management
- Dashboard with key metrics
- Complete product management with EAN code support

## Customer Features
- **B2B**: Product catalog browsing (`/products`), download capabilities
- **B2C**: Public storefront with modern e-commerce experience
- View-only access to active products
- Mobile-friendly interface
- Swedish localization throughout

## Swedish UI Text Examples
- "Kundhantering" (Customer Management)
- "Produktkatalog" (Product Catalog)
- "Produkthantering" (Product Management)
- "LÃ¤gg en bestÃ¤llning" (Place an Order)
- "Orderhistorik" (Order History)
- "InstÃ¤llningar" (Settings)
- "Aktivera/Inaktivera" (Activate/Deactivate)
- "Marginal %" (Margin %)
- "EAN-kod" (EAN Code)
- "Ladda ner" (Download)
- "Varukorg" (Shopping Cart)
- "Handla nu" (Shop Now)

## Development Workflow
1. Build: `npm run build`
2. Deploy: `firebase deploy --only hosting`
3. Test locally: `npm run dev`
4. Firebase console: https://console.firebase.google.com/project/b8shield-reseller-app

## Live URLs
- **B2B Portal**: https://b8shield-reseller-app.web.app
- **B2C Shop**: https://shop.b8shield.com
- **Admin Login**: micke.ohlen@gmail.com / temporaryPassword123

## Key Implementation Notes
- **Database**: ALWAYS use named database `b8s-reseller-db` (NEVER use default database)
- No demo mode in production (isDemoMode = false)
- Default customer margin: 35%
- All new customers require admin activation
- Swedish date formatting throughout
- Mobile-responsive design priority
- Consistent error handling and user feedback

## Recent Major Updates

### B2C E-commerce Storefront (Latest - June 2025)
- **Shared Navigation**: New `ShopNavigation` component for consistent header across all B2C pages
- **Working Cart System**: Persistent cart with localStorage, real-time updates, and count display
- **Shipping Costs**: Nordic (19 SEK) and international (59 SEK) shipping with country selection
- **VAT Handling**: Proper 25% VAT calculations and display
- **Subdomain Architecture**: Automatic routing between B2B and B2C based on shop.b8shield.com
- **2025 Design Implementation**: Modern gradients, glassmorphism, animations, micro-interactions
- **Consumer-Focused Interface**: Professional Swedish e-commerce experience
- **Product Image Generation**: Dynamic B8Shield branded images with color variants
- **Social Proof Integration**: Paul Wieringa testimonial with 5-star rating display
- **Mobile-First Responsive**: Optimized for all device sizes
- **Conversion Optimization**: Hero sections, features showcase, clear call-to-actions
- **Debug System**: Visual indicators for testing subdomain detection
- **Professional Footer**: Complete company information and social links

### Product Management System (Latest)
- **Complete Swedish Translation**: All product management UI in Swedish
- **EAN Code Support**: Added EAN code string field and image uploads (PNG/JPG + SVG)
- **Enhanced Product Form**: Professional styling with proper validation
- **Alphabetical Sorting**: Products sorted by name by default
- **Margin Field Removal**: Margins now handled at customer profile level
- **Image Upload Support**: Product images and EAN barcode images
- **Mobile Optimization**: Responsive design for all screen sizes

### Customer Product Catalog (Latest)
- **New Route**: `/products` for customer product browsing
- **View-Only Access**: Customers can browse but not edit products
- **Download Functionality**: Download product images and EAN codes
- **Filter & Search**: Product dropdown filter for easy navigation
- **Detailed Product View**: Full product information display
- **Navigation Integration**: Added "Produktkatalog" to main menu
- **Professional Design**: Consistent with portal styling

### Enhanced Customer Profiles
- **Delivery Address Fields**: Separate delivery address with "same as company" option
- **Comprehensive Registration**: Modern sectioned signup form
- **Address Management**: Both company and delivery addresses
- **Enhanced Profile Pages**: Structured view with collapsible sections
- **Admin Profile Management**: Full customer profile editing capabilities

### Customer Management System
- **Individual Customer Margins**: Each customer has custom percentage (default 35%)
- **Role-Based Access Control**: Admins can edit margins, customers cannot
- **Terminology Update**: Changed from "Users" to "Kunder" throughout
- **Inline Editing**: Direct margin editing in customer list
- **Comprehensive Profiles**: Full customer information management
- **Swedish Localization**: Complete Swedish terminology and validation

### Database Cleanup & Optimization
- **Single Database Usage**: Removed all references to default database
- **Consistent Firebase Integration**: All operations use `b8s-reseller-db`
- **Improved Error Handling**: Better debugging and error messages
- **Performance Optimization**: Streamlined database operations

## Navigation Structure
- **B2B Navigation**: Dashboard, Produktkatalog, MarknadsfÃ¶ringsmaterial, LÃ¤gg en bestÃ¤llning, Orderhistorik, Kontakt & Support, Profil
- **B2C Navigation**: Produkter, Varukorg, Logga in (simplified consumer experience)
- **Admin Navigation**: Admin Dashboard, Kunder, Ordrar, Produkter, MarknadsfÃ¶ring, InstÃ¤llningar
- **Customer Access**: All customers can access product catalog and marketing materials
- **Admin Access**: Full product management and marketing materials management

## Marketing Materials System (Latest)
- **Admin Interface**: Full upload/management system at `/admin/marketing`
- **Customer Interface**: View and download materials at `/marketing`
- **File Support**: Images, videos, PDFs, Word docs, archives (all formats)
- **Two Types**: Generic materials (all customers) + Customer-specific materials
- **Auto-populate**: Import from existing products database
- **Modern 2025 Design**: Gradients, animations, smart filtering
- **Statistics Dashboard**: Material counts and categorization
- **Swedish Localization**: Complete Swedish UI throughout
- **Download System**: One-click downloads with proper file naming
- **Security**: Admin-only uploads, role-based viewing permissions
- **Image Previews**: Real image thumbnails from Firebase Storage (fixed fileType detection)
- **Visual Interface**: Actual image previews for JPG/PNG/GIF/WebP/SVG files
- **Fallback System**: File type icons for non-images or failed loads

### Marketing Materials Database Schema
```javascript
// Firestore Collections:
// marketingMaterials (generic materials)
// users/{userId}/marketingMaterials (customer-specific)
{
  id: string,
  name: string,
  category: string, // 'AllmÃ¤nt', 'Produktbilder', 'EAN-koder', etc.
  fileType: string,
  fileSize: number,
  downloadUrl: string,
  uploadedBy: string,
  createdAt: timestamp,
  metadata: object
}
```

## IMPORTANT: Storage Rules Hack
**CRITICAL ISSUE**: Firebase Storage rules cannot access named database `b8s-reseller-db` for admin role verification. Database lookups in storage rules fail even with correct syntax.

**Current Workaround**: Hardcoded admin user IDs in storage rules instead of database lookups:
```javascript
function isAdmin() {
  return request.auth.uid in [
    '9AudFilG8VeYHcFnKgUtQkByAmn1',  // Primary admin
    '9yKlFQEhb4dbSwa206BxXVZWdgs2',  // Admin 2  
    'hCu3TDpe5XZ0adTp5eGLpGxDvL13'   // Admin 3
  ];
}
```

**TODO**: Investigate why storage rules cannot access named database. May need to:
1. Use default database for admin users only
2. Find alternative Firebase Storage rules syntax
3. Implement server-side admin verification
4. Update to newer Firebase Storage rules version

**Files Affected**: 
- `storage.rules` - Uses hardcoded admin IDs
- `src/utils/marketingMaterials.js` - Marketing materials utilities
- `src/pages/admin/AdminMarketingMaterials.jsx` - Admin interface with image previews
- `src/pages/MarketingMaterialsPage.jsx` - Customer interface with image previews

## Firebase Storage Migration (Latest)

### Product Images Now Use Firebase Storage
- **Migration**: Moved from base64 Firestore storage to Firebase Storage URLs
- **Benefits**: 
  - **Performance**: 5x faster loading, no more 1MB document size limits
  - **Cost**: 90% cheaper storage costs vs Firestore binary data
  - **Scalability**: No document size restrictions, supports larger images
  - **CDN**: Automatic global CDN distribution for faster image delivery
- **Implementation**: 
  - New fields: `imageUrl`, `eanImagePngUrl`, `eanImageSvgUrl`
  - Legacy support: Still reads `imageData`, `eanImagePng`, `eanImageSvg`
  - Upload progress: Shows "Laddar upp bilder..." during file uploads
  - Storage path: `/products/{productId}/{timestamp}_{filename}`
- **Affected Components**: AdminProducts, ProductViewPage, PublicStorefront
- **Status**: âœ… Deployed and operational

### Marketing Materials Image Previews (Fixed)
- **Issue**: Materials showed emoji icons instead of actual image previews
- **Root Cause**: `getFileType()` returns `'image'` but components checked for `'image/'` (MIME format)
- **Solution**: Changed condition from `material.fileType?.startsWith('image/')` to `material.fileType === 'image'`
- **Result**: Real image thumbnails now display from Firebase Storage `downloadURL`
- **Affected Files**: `MarketingMaterialsPage.jsx`, `AdminMarketingMaterials.jsx`
- **Status**: âœ… Fixed and deployed

## Current Development Status

### âœ… Completed (June 2025)
- **B2C Storefront**: Stunning 2025 design with subdomain routing
- **Shopping Cart System**: Full cart functionality with persistent storage, shipping costs, and VAT
- **Subdomain Detection**: Automatic B2B/B2C routing via shop.b8shield.com
- **Product Image Generation**: Dynamic B8Shield branded images
- **Social Proof**: Integrated testimonials and trust signals
- **Mobile Optimization**: Responsive design across all components
- **Firebase Storage Migration**: All product images now use Firebase Storage instead of base64
- **Legacy Compatibility**: Backward compatibility with existing base64 images

### ðŸš§ In Progress (Next Priority)
- **Enhanced Product Architecture**: B2B/B2C image separation and availability controls
- **Tabbed Admin Interface**: Separate B2B and B2C product management
- **Product Variants**: Different sizes/pricing for B2B vs B2C markets
- **Market-Specific Descriptions**: Technical (B2B) vs consumer-friendly (B2C) copy

### ðŸ“‹ Planned Features
- **Stripe Integration**: Secure payment processing for B2C
- **Customer Authentication**: B2C customer accounts and order history
- **Enhanced Product Detail Pages**: Rich product information and image galleries
- **Inventory Management**: Stock tracking across B2B and B2C
- **Analytics Dashboard**: Sales metrics and conversion tracking

## Product Strategy

### B2B Products (Resellers)
- **Technical Images**: Product specifications, EAN codes, packaging
- **Bulk Pricing**: Volume discounts, minimum order quantities
- **Professional Descriptions**: Technical specifications, margin information
- **Exclusive Products**: Large bulk packs, professional variants

### B2C Products (Consumers)
- **Lifestyle Images**: Action shots, fishing scenes, before/after comparisons
- **Consumer Pricing**: Individual units, small multipacks (3-pack, 5-pack)
- **Marketing Copy**: Benefit-focused, emotional appeals, ease of use
- **Exclusive Products**: Starter kits, gift sets, consumer bundles

### Shared Infrastructure
- **Single Admin Panel**: Manage both B2B and B2C from one interface
- **Unified Database**: One product database with market-specific fields
- **Flexible Availability**: Easy to enable/disable products per market
- **Cost Efficiency**: Significant savings vs separate Shopify/WooCommerce systems
