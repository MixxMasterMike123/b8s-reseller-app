# B8Shield Reseller Portal - Cursor Rules

## Project Overview
B8Shield is a Swedish reseller portal for JPH Innovation AB's fishing lure protection product. The portal manages customer orders, user accounts, and provides admin functionality for customer management.

## Technology Stack
- **Frontend**: React 18 + Vite
- **Styling**: Tailwind CSS
- **Backend**: Firebase (Firestore, Auth, Hosting)
- **State Management**: React Context API
- **Routing**: React Router
- **Icons**: Heroicons
- **Notifications**: react-hot-toast
- **Date Handling**: date-fns with Swedish locale

## Key Project Structure
```
src/
├── components/
│   ├── auth/ (PrivateRoute, AdminRoute)
│   └── layout/ (AppLayout)
├── contexts/ (AuthContext, OrderContext)
├── pages/
│   ├── admin/ (AdminDashboard, AdminUsers, AdminOrders, AdminProducts)
│   ├── ProductViewPage (Customer product catalog)
│   └── [user pages]
├── firebase/config.js
└── utils/
```

## Language & Terminology
- **Primary Language**: Swedish (Svenska)
- **Users**: Referred to as "Kunder" (customers) or "Företag" (companies)
- **UI Text**: Swedish throughout (e.g., "Kundhantering", "Beställningar", "Inställningar")
- **Field Names**: Swedish database fields (e.g., `marginal`, `företagsnamn`)

## Key Features Implemented

### Customer Management System
- Individual customer margins (default: 35%)
- Admin can edit customer margins inline
- Customer activation/deactivation
- Role management (user/admin)
- Swedish terminology throughout
- Comprehensive customer profiles with delivery addresses

### Product Management & Catalog
- **Admin Product Management**: Full CRUD operations with Swedish interface
- **Customer Product Catalog**: View-only access at `/products` route
- **EAN Code Support**: String field + PNG/JPG and SVG image uploads
- **Download Capabilities**: Customers can download product images and EAN codes
- **Sorting & Filtering**: Alphabetical sorting, product filter dropdown
- **Mobile Optimized**: Responsive design for all devices

### Authentication & Authorization
- Firebase Authentication
- Role-based access (user/admin)
- Admin-only routes and functions
- Account activation required

### Order Management
- Order creation and tracking
- Status management
- Order history
- Admin order oversight

## Database Schema (Firestore)

### Users Collection
```javascript
{
  id: string,
  email: string,
  companyName: string,
  contactPerson: string,
  phone: string,
  orgNumber: string,
  address: string,
  city: string,
  postalCode: string,
  country: string,
  deliveryAddress: string,
  deliveryCity: string,
  deliveryPostalCode: string,
  deliveryCountry: string,
  sameAsCompanyAddress: boolean,
  role: 'user' | 'admin',
  active: boolean,
  marginal: number, // Customer margin percentage (default: 35)
  notes: string,
  createdAt: string,
  updatedAt: string
}
```

### Products Collection
```javascript
{
  id: string,
  name: string,
  description: string,
  size: string,
  basePrice: number,
  manufacturingCost: number,
  isActive: boolean,
  imageData: string, // Base64 product image
  eanCode: string,
  eanImagePng: string, // Base64 PNG/JPG EAN barcode
  eanImageSvg: string, // Base64 SVG EAN barcode
  createdAt: string,
  updatedAt: string
}
```

### Orders Collection
```javascript
{
  id: string,
  userId: string,
  status: string,
  items: array,
  totalAmount: number,
  createdAt: string,
  updatedAt: string
}
```

## Coding Conventions

### React Patterns
- Functional components with hooks
- Context API for global state
- Custom hooks for reusable logic
- Consistent error handling with toast notifications

### Styling Guidelines
- Tailwind CSS utility classes
- Consistent color scheme (blue primary, gray neutrals)
- Mobile-first responsive design
- Hover states and transitions

### Firebase Integration
- **ALWAYS use named database**: `b8s-reseller-db` (NEVER use default database)
- Error handling for offline scenarios
- Real-time updates where appropriate
- Proper security rules

## Admin Features
- Customer management with inline editing
- Margin percentage control per customer
- User activation/deactivation
- Order oversight and management
- Dashboard with key metrics
- Complete product management with EAN code support

## Customer Features
- Product catalog browsing (`/products`)
- Download product images and EAN codes
- View-only access to active products
- Mobile-friendly interface
- Swedish localization throughout

## Swedish UI Text Examples
- "Kundhantering" (Customer Management)
- "Produktkatalog" (Product Catalog)
- "Produkthantering" (Product Management)
- "Lägg en beställning" (Place an Order)
- "Orderhistorik" (Order History)
- "Inställningar" (Settings)
- "Aktivera/Inaktivera" (Activate/Deactivate)
- "Marginal %" (Margin %)
- "EAN-kod" (EAN Code)
- "Ladda ner" (Download)

## Development Workflow
1. Build: `npm run build`
2. Deploy: `firebase deploy --only hosting`
3. Test locally: `npm run dev`
4. Firebase console: https://console.firebase.google.com/project/b8shield-reseller-app

## Live URLs
- **Production**: https://b8shield-reseller-app.web.app
- **Admin Login**: micke.ohlen@gmail.com / temporaryPassword123

## Key Implementation Notes
- **Database**: ALWAYS use named database `b8s-reseller-db` (NEVER use default database)
- No demo mode in production (isDemoMode = false)
- Default customer margin: 35%
- All new customers require admin activation
- Swedish date formatting throughout
- Mobile-responsive design priority
- Consistent error handling and user feedback

## Recent Major Updates

### Product Management System (Latest)
- **Complete Swedish Translation**: All product management UI in Swedish
- **EAN Code Support**: Added EAN code string field and image uploads (PNG/JPG + SVG)
- **Enhanced Product Form**: Professional styling with proper validation
- **Alphabetical Sorting**: Products sorted by name by default
- **Margin Field Removal**: Margins now handled at customer profile level
- **Image Upload Support**: Product images and EAN barcode images
- **Mobile Optimization**: Responsive design for all screen sizes

### Customer Product Catalog (Latest)
- **New Route**: `/products` for customer product browsing
- **View-Only Access**: Customers can browse but not edit products
- **Download Functionality**: Download product images and EAN codes
- **Filter & Search**: Product dropdown filter for easy navigation
- **Detailed Product View**: Full product information display
- **Navigation Integration**: Added "Produktkatalog" to main menu
- **Professional Design**: Consistent with portal styling

### Enhanced Customer Profiles
- **Delivery Address Fields**: Separate delivery address with "same as company" option
- **Comprehensive Registration**: Modern sectioned signup form
- **Address Management**: Both company and delivery addresses
- **Enhanced Profile Pages**: Structured view with collapsible sections
- **Admin Profile Management**: Full customer profile editing capabilities

### Customer Management System
- **Individual Customer Margins**: Each customer has custom percentage (default 35%)
- **Role-Based Access Control**: Admins can edit margins, customers cannot
- **Terminology Update**: Changed from "Users" to "Kunder" throughout
- **Inline Editing**: Direct margin editing in customer list
- **Comprehensive Profiles**: Full customer information management
- **Swedish Localization**: Complete Swedish terminology and validation

### Database Cleanup & Optimization
- **Single Database Usage**: Removed all references to default database
- **Consistent Firebase Integration**: All operations use `b8s-reseller-db`
- **Improved Error Handling**: Better debugging and error messages
- **Performance Optimization**: Streamlined database operations

## Customer Management Features
- **List View**: Compact table with inline margin editing, role management, search/filter
- **Detailed Edit**: Full customer profile editing with all fields and admin controls
- **Role-Based Access**: Admins see margin field, regular users cannot edit margins
- **Swedish Localization**: Complete Swedish terminology and validation messages
- **Mobile Optimized**: Responsive design with vertical stacking for small screens

## Product Management Features
- **Admin Interface**: Full CRUD operations with Swedish translation
- **Customer Catalog**: View-only product browsing with download capabilities
- **EAN Code Support**: String field and dual image format support (PNG/JPG + SVG)
- **Image Management**: Product images and barcode images
- **Sorting & Filtering**: Alphabetical sorting, product filter dropdown
- **Download System**: One-click downloads with proper file naming
- **Mobile Responsive**: Works on all device sizes

## Customer Profile Fields
- Company information (name, org number)
- Contact details (person, phone, email)  
- Company address (street, city, postal code, country)
- Delivery address (separate fields with "same as company" option)
- Admin-only fields (margin %, role, active status, notes)
- Form validation with Swedish error messages

## Navigation Structure
- **Main Navigation**: Dashboard, Produktkatalog, Marknadsföringsmaterial, Lägg en beställning, Orderhistorik, Kontakt & Support, Profil
- **Admin Navigation**: Admin Dashboard, Kunder, Ordrar, Produkter, Marknadsföring, Inställningar
- **Customer Access**: All customers can access product catalog and marketing materials
- **Admin Access**: Full product management and marketing materials management

## Marketing Materials System (Latest)
- **Admin Interface**: Full upload/management system at `/admin/marketing`
- **Customer Interface**: View and download materials at `/marketing`
- **File Support**: Images, videos, PDFs, Word docs, archives (all formats)
- **Two Types**: Generic materials (all customers) + Customer-specific materials
- **Auto-populate**: Import from existing products database
- **Modern 2025 Design**: Gradients, animations, smart filtering
- **Statistics Dashboard**: Material counts and categorization
- **Swedish Localization**: Complete Swedish UI throughout
- **Download System**: One-click downloads with proper file naming
- **Security**: Admin-only uploads, role-based viewing permissions
- **Image Previews**: Real image thumbnails from Firebase Storage (fixed fileType detection)
- **Visual Interface**: Actual image previews for JPG/PNG/GIF/WebP/SVG files
- **Fallback System**: File type icons for non-images or failed loads

### Marketing Materials Database Schema
```javascript
// Firestore Collections:
// marketingMaterials (generic materials)
// users/{userId}/marketingMaterials (customer-specific)
{
  id: string,
  name: string,
  category: string, // 'Allmänt', 'Produktbilder', 'EAN-koder', etc.
  fileType: string,
  fileSize: number,
  downloadUrl: string,
  uploadedBy: string,
  createdAt: timestamp,
  metadata: object
}
```

## IMPORTANT: Storage Rules Hack
**CRITICAL ISSUE**: Firebase Storage rules cannot access named database `b8s-reseller-db` for admin role verification. Database lookups in storage rules fail even with correct syntax.

**Current Workaround**: Hardcoded admin user IDs in storage rules instead of database lookups:
```javascript
function isAdmin() {
  return request.auth.uid in [
    '9AudFilG8VeYHcFnKgUtQkByAmn1',  // Primary admin
    '9yKlFQEhb4dbSwa206BxXVZWdgs2',  // Admin 2  
    'hCu3TDpe5XZ0adTp5eGLpGxDvL13'   // Admin 3
  ];
}
```

**TODO**: Investigate why storage rules cannot access named database. May need to:
1. Use default database for admin users only
2. Find alternative Firebase Storage rules syntax
3. Implement server-side admin verification
4. Update to newer Firebase Storage rules version

**Files Affected**: 
- `storage.rules` - Uses hardcoded admin IDs
- `src/utils/marketingMaterials.js` - Marketing materials utilities
- `src/pages/admin/AdminMarketingMaterials.jsx` - Admin interface with image previews
- `src/pages/MarketingMaterialsPage.jsx` - Customer interface with image previews

## Latest Bug Fixes (Latest)

### Marketing Materials Image Previews (Fixed)
- **Issue**: Materials showed emoji icons instead of actual image previews
- **Root Cause**: `getFileType()` returns `'image'` but components checked for `'image/'` (MIME format)
- **Solution**: Changed condition from `material.fileType?.startsWith('image/')` to `material.fileType === 'image'`
- **Result**: Real image thumbnails now display from Firebase Storage `downloadURL`
- **Affected Files**: `MarketingMaterialsPage.jsx`, `AdminMarketingMaterials.jsx`
- **Status**: ✅ Fixed and deployed
